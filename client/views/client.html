<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <script src="../javascripts/jquery.min.js"></script>
    <script src="../javascripts/moment/moment.js"></script>
    <script src="../javascripts/moment-jalaali/build/moment-jalaali.js"></script>
    <link rel="stylesheet" href="../stylesheets/style.css">
    <title>Smart Entrance</title>
</head>
<body>
<div class="">

    <div id="alertTop">
        <h3></h3>
    </div>
    <div class="nav">
        <p class="clock"></p>
        <p class="date"></p>
        <h1>Smart Entrance</h1>
        <button id="giot" title="Green IOT"></button>
    </div>
    <div class="clientMonitor">
        <!-- <h2> Current Classes </h2> -->
        <ul class="classList">

        </ul>
    </div>
    <div id="admin">
        <button class="closeAdmin">

        </button>
        <h1 class="show">Admin Panel</h1>
        <h2 class="users"> Users </h2>
        <ul class="usrList">

        </ul>
    </div>
    <div class="clientButtons">
        <span class="marginTop">  Enter your RFID Card or Fingerprint </span>
    </div>
</div>
</body>

<script>
    var me = null;
    var countDown ;
    let seconds = 9;
    var timer;
    var thisDay ;
    var classesList = [];
    let turnInterval = null;
    let clientTimerInterval = null;
    function WebSocketTest() {
           if ("WebSocket" in window) {
              alert("WebSocket is supported by your Browser!");
              var ws = new WebSocket("ws://localhost:3004");
              ws.onopen = function() {
                 alert("Connected to the server");
              };
              ws.onmessage = function (evt) { 
                    var received_msg = evt.data;
                    let zz = false;
                    let data = null;
                    data = JSON.parse(received_msg);
                    if(data.role && ( data.role==="superuser" || data.role === "admin")){
                        zz = true;
                    }
                    showServerResponse(data.type+"/"+data.message,zz);
                    
              };
              ws.onclose = function() { 
                 alert("Connection is closed..."); 
              };
           } else {
              alert("WebSocket NOT supported by your Browser!");
           }
        }

    $(document).ready(function(){
        initPage();
        initClock();
        initDate();
        WebSocketTest();
        // setInterval(function(){
        //     checkAdminCommands();
        // },5000);
    });
    function showServerResponse(message,admin){
        clearInterval(clientTimerInterval);
        if(message.startsWith("A")){
            $(".clientButtons span").html(message.split("/")[1]);
        }
        else if(message.startsWith("G")){
            $(".clientButtons span").html('Access Granted ,' + message.split("/")[1]);
            if(admin){
                $("#admin").addClass("show");
                getAllUsers();
            }
        }
        else if(message.startsWith("D")){
            $(".clientButtons span").html('Access Denied');
        }
        else if(message.startsWith("R")){
            $(".clientButtons span").html(message.split("/")[1]);
        }
        clientTimerInterval = setTimeout(function(){
                $(".clientButtons span").html("Enter your RF-ID Card");
            },5000);
    }
    $("body").on("click",".closeAdmin",function(){ // classes list show
        logoutAndRefresh();
    });
    $("body").on("click","#admin ul .sample.rfid",function(){
        username = $(this).siblings("span").html();
        sampleState($(this),"rfid");
    });
    function logoutAndRefresh(){
        $.ajax({
            url:"/client/logout",
            method:"POST",
            beforeSend:function(){
                $("#admin .classList").html("");
            },
            success:function(res){
                window.location.reload();
            },
            fail: function (res) {
                console.log(res);
                alert("No connection to server");
            },
            timeout: function () {
                alert("No connection to server");
            }
        });
    }
    function initPage(){

    }
    function alert(message){
        $("#alertTop h3").html(message);
        $("#alertTop").addClass("show");
        setTimeout(function (){
            $("#alertTop").removeClass("show");
            // Something you want delayed.
        }, 5000); // 5seconds show
    }
    function fakeAuth(z){
        $.ajax({
            url:"/client/takeSample",
            method:"POST",
            data:{
                rfId:z
            },
            success:function(res){
                console.log(JSON.stringify(res));
                
            },
            fail: function (res) {
                console.log(res);
                alert("No connection to server");
            },
            timeout: function () {
                alert("No connection to server");
            }
        });
    }
    
    function initDate(){
        $(".date").html(moment().format('jYYYY/jM/jD'));
    }
    function initClock() {
        setInterval(function(){
            let dates = new Date().toString().split(" ");
            thisDay = dates[0];
            $(".clock").html( thisDay + " " + dates[4].split(":")[0]+":"+dates[4].split(":")[1]+":"+dates[4].split(":")[2]);
        },999)
    }
   
    
    function getAllUsers(){
        if(!$("#admin .usrList.show")[0]){
            $("#admin .usrList").addClass("show");
        }
        $("#admin .usrList").html("");
        $.ajax({
            url: "/client/getUsers",
            method: "GET",
            beforeSend:function(){
                $("#admin .usrList").html("");
            },
            success: function (res) {
                if (!res.message) {
                    if (res.length > 0) {
                        $.each(res, function (index, data) {
                            $("#admin .usrList").append(`
                                <li class="eachUser" id="user-${res[index].username}">
                                <span>${res[index].username}</span>
                                <span>${res[index].userId}</span>
                                <button class="sample rfid" title="Get RFID Sample"></button>
                                </li>
                            `);
                        });
                    }
                    else{
                        $("#admin .usrList").append(`
                           <li class="eachUser">
                                <span>No user defined !</span>
                            </li>
                         `);
                    }
                }
            },
            fail:function(){
                alert("No connection to server");
            },
            timeout:function(){
                alert("No connection to server");
            }
        });
    }
    function sampleState(element,type){
        var x = {
            username: username,
            type:type
        };
        $.ajax({
            url: "/client/takeSampleState",
            method: "POST",
            data: x,
            beforeSend:function(){
                turnButton(element);
            },
            success: function (res) {
                clearInterval(turnInterval);
                alert(res.message);
            },
            fail: function (res) {
                console.log(res);
                alert("No connection to server");
            },
            timeout: function () {
                alert("No connection to server");
            }
        });
    }
    function turnButton(element){
        turnInterval = setInterval(function(){
            if(element[0].className.split("turn").length === 1){
                element.addClass("turn");
            }
            else{
                element.removeClass("turn");
            }
        },500);
    }
</script>
</html>